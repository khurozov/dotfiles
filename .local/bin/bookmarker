#!/bin/sh

set -eo pipefail

ifinstalled fuzzel

file="$HOME/.local/share/bookmarks"
test -f "$file"

open_bm() {
    bookmark="$(grep -v -E '^#|^\s*$' "$file" | fuzzel -Rdw 100)"

    $BROWSER "${bookmark%% *}"
}

edit_bm() {
    $TERMINAL $EDITOR "$file"
}

open_tagged_bm() {
    tags="$(sed -nr 's|.*tag://([\w-]+)|\1|p' "$file" | tr '-' '\n' | sort | uniq)"

    test -n "$tags"

    if [ "$(echo "$tags" | wc -l)" -eq 1 ]; then
        tag="$tags"
    else
        tag="$(echo "$tags" | fuzzel -d -p "tag: ")"
    fi

    for t in $(sed -nr "s|([^ ]+) .*tag://.*$tag.*|\1|p" "$file"); do
        $BROWSER "$t" &
    done
}

case "$1" in
    open)   open_bm;;
    edit)   edit_bm;;
    tags)   open_tagged_bm;;
esac
